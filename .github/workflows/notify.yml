name: Notify
on:
  issues:
    types: [opened, reopened, closed]
jobs:
  notify:
    name: Notify
    if: ${{ contains(github.event.issue.title, 'ðŸ›‘') }}
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_PAT }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Opened
        if: ${{ github.event.issue.state != 'closed' }}
        shell: bash
        run: |
          echo "post feishu message for service down"
          response=$(curl -d "{\"chat\":\"network\",\"title\":\"Upptime é€šçŸ¥\",\"body\":\"${{ github.event.issue.title }} [#${{ github.event.issue.number }}](${{ github.event.issue.html_url }}) at $(TZ=Asia/Shanghai date +'%Y-%m-%dT%H:%M:%S%:z')\"}" -H 'Content-Type: application/json' -H 'Authorization: Bearer ${{ secrets.FEISHU_SERVICE_TOKEN }}' -X 'POST' 'https://feishu.zzc.cool/service/notification?feishu_msg_type=wrapped_text')
          if [ "$(echo $response | jq -r '.ok')" = "true" ]; then
            echo "put issue with feishu message id"
            body=$(gh issue view "${{ github.event.issue.number }}" --json 'body' --jq '.body')
            body="$body"$'\n- Feishu message: '"$(echo $response | jq -r '.feishu_response.data.message_id')"
            gh issue edit "${{ github.event.issue.number }}" --body "$body"
          fi
      - name: Closed
        if: ${{ github.event.issue.state == 'closed' }}
        shell: bash
        run: |
          issue_title="${{ github.event.issue.title }}"
          issue_title="${issue_title/ðŸ›‘/ðŸ†—}"
          issue_title="${issue_title/down/up}"
          #
          echo "get issue with feishu message id"
          if [[ "${{ github.event.issue.body }}" =~ (om_[a-z0-9]+) ]]; then
            echo "get feishu message"
            response=$(curl -H 'Authorization: Bearer ${{ secrets.FEISHU_SERVICE_TOKEN }}' -X 'GET' "https://feishu.zzc.cool/service/notification?feishu_message_id=${BASH_REMATCH[1]}")
            text=$(echo $response | jq -r '.data.text | @json')
            text=${text//\"/}
            text="${text/Upptime é€šçŸ¥/<b>Upptime é€šçŸ¥</b>}\n${issue_title} [#${{ github.event.issue.number }}](${{ github.event.issue.html_url }}) at $(TZ=Asia/Shanghai date +'%Y-%m-%dT%H:%M:%S%:z')"
            echo "put feishu message with service up"
            curl -d "{\"text\":\"${text}\"}" -H 'Content-Type: application/json' -H 'Authorization: Bearer ${{ secrets.FEISHU_SERVICE_TOKEN }}' -X 'PUT' "https://feishu.zzc.cool/service/notification?feishu_message_id=${BASH_REMATCH[1]}&&feishu_msg_type=text"
            echo ""
          else
            echo "post feishu message for service up"
            curl -d "{\"chat\":\"network\",\"title\":\"Upptime é€šçŸ¥\",\"body\":\"$issue_title [#${{ github.event.issue.number }}](${{ github.event.issue.html_url }}) at $(TZ=Asia/Shanghai date +'%Y-%m-%dT%H:%M:%S%:z')\"}" -H 'Content-Type: application/json' -H 'Authorization: Bearer ${{ secrets.FEISHU_SERVICE_TOKEN }}' -X 'POST' 'https://feishu.zzc.cool/service/notification?feishu_msg_type=wrapped_text'
            echo ""
          fi
