name: Notify
on:
  issues:
    types: [opened, reopened, closed]
jobs:
  notify:
    name: Notify
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_PAT }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Opened
        if: ${{ github.event.issue.state != 'closed' }}
        shell: bash
        run: |
          echo "post feishu message for service down"
          response=$(curl -d '{"chat":"network","title":"Upptime é€šçŸ¥","body":"${{ github.event.issue.title }} [#${{ github.event.issue.number }}](${{ github.event.issue.html_url }})"}' -H 'Content-Type: application/json' -H 'Authorization: Bearer ${{ secrets.FEISHU_SERVICE_TOKEN }}' -X 'POST' 'https://feishu.zzc.cool/service/notification?feishu_msg_type=text')
          if [ "$(echo $response | jq -r '.ok')" = "true" ]; then
            echo "post issue comment with feishu message id"
            feishu_message_id=$(echo $response | jq -r '.feishu_response.data.message_id')
            gh issue unlock "${{ github.event.issue.number }}"
            gh issue comment "${{ github.event.issue.number }}" --body "$feishu_message_id"
            gh issue lock "${{ github.event.issue.number }}"          
          fi
      - name: Closed
        if: ${{ github.event.issue.state == 'closed' }}
        shell: bash
        run: |
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_TITLE="${ISSUE_TITLE/ðŸ›‘/ðŸ†—}"
          ISSUE_TITLE="${ISSUE_TITLE/down/up}"
          #
          echo "get issue comment with feishu message id"
          issue_comment_list=$(gh issue view "${{ github.event.issue.number }}" --json comments --jq '.comments' || echo "[]")
          feishu_message_id=$(echo "$issue_comment_list" | jq -r '.[0].body // ""')
          if [[ "$feishu_message_id" =~ om_[a-z0-9]+ ]]; then
            echo "put feishu message with service up"
            curl -d "{\"chat\":\"network\",\"title\":\"Upptime é€šçŸ¥\",\"body\":\"${{ github.event.issue.title }} [#${{ github.event.issue.number }}](${{ github.event.issue.html_url }})\n\n$ISSUE_TITLE [#${{ github.event.issue.number }}](${{ github.event.issue.html_url }}) at $(TZ=Asia/Shanghai date +'%Y-%m-%dT%H:%M:%S%:z')\"}" -H 'Content-Type: application/json' -H 'Authorization: Bearer ${{ secrets.FEISHU_SERVICE_TOKEN }}' -X 'PUT' "https://feishu.zzc.cool/service/notification?feishu_message_id=$feishu_message_id"
            echo ""
            #
            echo "delete issue comment with feishu message id"
            comment_url=$(echo "$issue_comment_list" | jq -r '.[0].url')
            comment_number=${comment_url##*issuecomment-}
            gh issue unlock "${{ github.event.issue.number }}"
            gh api --method DELETE "/repos/${{github.repository}}/issues/comments/$comment_number"
            gh issue lock "${{ github.event.issue.number }}"
          else
            echo "post feishu message for service up"
            curl -d "{\"chat\":\"network\",\"title\":\"Upptime é€šçŸ¥\",\"body\":\"$ISSUE_TITLE [#${{ github.event.issue.number }}](${{ github.event.issue.html_url }})\"}" -H 'Content-Type: application/json' -H 'Authorization: Bearer ${{ secrets.FEISHU_SERVICE_TOKEN }}' -X 'POST' 'https://feishu.zzc.cool/service/notification?feishu_msg_type=text'
            echo ""
          fi
